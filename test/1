(async () => {
    // ■ GUI
    if(document.getElementById('ddb-crawler-panel')) document.getElementById('ddb-crawler-panel').remove();
    const panel = document.createElement('div');
    panel.id = 'ddb-crawler-panel';
    Object.assign(panel.style, {
        position: 'fixed', top: '10px', right: '10px', width: '420px',
        backgroundColor: '#111827', color: '#f3f4f6', padding: '16px',
        borderRadius: '12px', zIndex: '999999', fontFamily: 'sans-serif', fontSize: '12px',
        boxShadow: '0 10px 30px rgba(0,0,0,0.5)', border: '1px solid #374151'
    });
    panel.innerHTML = `
        <h3 style="margin:0 0 12px;font-size:14px;font-weight:700;color:#f472b6;border-bottom:1px solid #374151;padding-bottom:8px">
            Dokkan Scraper v8 (Focus Passive)
        </h3>
        <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
            <input type="number" id="ddb-start" placeholder="Start" value="1000000" style="width:100px;background:#1f2937;border:1px solid #4b5563;color:#fff;padding:6px;border-radius:4px">
            <span style="color:#9ca3af">~</span>
            <input type="number" id="ddb-end" placeholder="End" value="1000050" style="width:100px;background:#1f2937;border:1px solid #4b5563;color:#fff;padding:6px;border-radius:4px">
        </div>
        <div style="margin-bottom:12px;display:flex;gap:8px;">
            <button id="ddb-btn-start" style="flex:1;background:#db2777;color:#fff;border:none;padding:8px;border-radius:4px;cursor:pointer;font-weight:bold">開始</button>
            <button id="ddb-btn-stop" style="flex:1;background:#dc2626;color:#fff;border:none;padding:8px;border-radius:4px;cursor:pointer;font-weight:bold" disabled>停止</button>
        </div>
        <div style="margin-bottom:6px;font-weight:bold;display:flex;justify-content:space-between">
            <span id="ddb-status">待機中</span>
            <span id="ddb-count">0/0</span>
        </div>
        <div style="background:#1f2937;height:8px;border-radius:4px;margin-bottom:12px;overflow:hidden">
            <div id="ddb-progress" style="width:0%;height:100%;background:#f472b6;transition:width 0.3s ease"></div>
        </div>
        <div id="ddb-log" style="height:250px;overflow-y:auto;background:#030712;padding:8px;font-family:monospace;color:#d1d5db;border:1px solid #1f2937;border-radius:4px;line-height:1.4"></div>
        <div style="margin-top:12px;text-align:right">
            <button id="ddb-btn-dl" style="background:#059669;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer;font-weight:bold" disabled>結果を保存 (.txt)</button>
        </div>
    `;
    document.body.appendChild(panel);

    // ■ State
    let isRunning = false;
    let finalResults = []; 

    const log = (msg, color='#e5e7eb') => {
        const div = document.createElement('div');
        div.innerHTML = `<span style="color:#6b7280;font-size:10px">${new Date().toLocaleTimeString()}</span> <span style="color:${color}">${msg}</span>`;
        const box = document.getElementById('ddb-log');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        document.getElementById('ddb-status').textContent = msg.replace(/<[^>]*>?/gm, '');
    };

    // ■ イベント
    document.getElementById('ddb-btn-start').onclick = start;
    document.getElementById('ddb-btn-stop').onclick = () => { isRunning = false; };
    document.getElementById('ddb-btn-dl').onclick = download;

    async function start() {
        isRunning = true;
        finalResults = [];
        document.getElementById('ddb-btn-start').disabled = true;
        document.getElementById('ddb-btn-stop').disabled = false;

        const startId = parseInt(document.getElementById('ddb-start').value);
        const endId = parseInt(document.getElementById('ddb-end').value);

        // iframe準備
        let iframe = document.getElementById('ddb-iframe');
        if(!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = 'ddb-iframe';
            Object.assign(iframe.style, {width:'1200px', height:'1200px', position:'fixed', bottom:'-3000px', right:'-3000px', visibility:'hidden'});
            document.body.appendChild(iframe);
        }

        // Loop: 末尾0のみ対象
        const queue = [];
        for(let i=startId; i<=endId; i++) {
            if(i%10 === 0) queue.push(i);
        }

        log(`Start: ${queue.length}件を処理します`, '#f472b6');

        for(let i=0; i<queue.length; i++) {
            if(!isRunning) break;
            const baseId = queue[i];
            
            updateProgress(i, queue.length);
            log(`[${baseId}] 処理中...`, '#fff');

            let blockContent = "";

            // --- 1. Base (xxx0) ---
            const baseData = await fetchPage(iframe, baseId);
            if(baseData.status === '404') {
                log(`  Base未発見 -> Skip`, '#6b7280');
                continue;
            }
            
            blockContent += baseData.formatted;
            log(`  Base OK`, '#4ade80');

            // --- 2. Base Transform (4xxx0) ---
            await checkTransforms(iframe, baseId, (txt) => {
                blockContent += txt;
                log(`  ↳ 変身(Base) OK`, '#60a5fa');
            });

            // --- 3. EZA (xxx1) ---
            const ezaId = baseId + 1;
            const ezaData = await fetchPage(iframe, ezaId);
            
            if(ezaData.status === 'success') {
                // 重複排除: 名前とパッシブのみで判定
                if(baseData.name === ezaData.name && baseData.passiveSignature === ezaData.passiveSignature) {
                    log(`  EZA重複(Signature一致) -> Skip`, '#9ca3af');
                } else {
                    blockContent += ezaData.formatted;
                    log(`  EZA OK (Active)`, '#a78bfa');

                    // --- 4. EZA Transform (4xxx1) ---
                    await checkTransforms(iframe, ezaId, (txt) => {
                        blockContent += txt;
                        log(`  ↳ 変身(EZA) OK`, '#c084fc');
                    });
                }
            } else {
                // EZAページ自体がない場合
                 log(`  EZAなし`, '#4b5563');
            }

            // ブロック結合
            finalResults.push(blockContent + "\n\n===\n\n");
            
            await new Promise(r => setTimeout(r, 800));
        }

        isRunning = false;
        log(`完了: ${finalResults.length}件`, '#f472b6');
        document.getElementById('ddb-btn-start').disabled = false;
        document.getElementById('ddb-btn-stop').disabled = true;
        document.getElementById('ddb-btn-dl').disabled = false;
        updateProgress(1, 1);
    }

    // 変身形態チェック関数
    async function checkTransforms(iframe, sourceId, onFound) {
        // ID変換ロジック: 1032120 -> 4032120 (+0), 4032130 (+10)
        const idStr = String(sourceId);
        if(!idStr.startsWith('1')) return; 

        const suffix = idStr.substring(1); 
        const tBase = 4000000 + parseInt(suffix); 

        const candidates = [
            tBase,      // パターンA
            tBase + 10  // パターンB
        ];

        for(const cid of candidates) {
            if(cid === sourceId) continue;
            await new Promise(r => setTimeout(r, 300));

            const res = await fetchPage(iframe, cid);
            if(res.status === 'success') {
                if(res.cleanText.length > 50) {
                    onFound(res.formatted);
                }
            }
        }
    }

    async function fetchPage(iframe, id) {
        const url = `https://jpn.dokkan.wiki/cards/${id}`;
        iframe.src = 'about:blank'; 
        
        return new Promise(resolve => {
            const timer = setTimeout(() => resolve({status:'timeout'}), 15000);
            
            iframe.src = url;
            
            const checker = setInterval(() => {
                const doc = iframe.contentWindow?.document;
                if(!doc) return;
                
                const h1 = doc.querySelector('h1.Title') || doc.querySelector('h1');
                if(h1 && h1.innerText.length > 0) {
                    const title = h1.innerText.trim();
                    if(title.includes('404') || title.includes('Oops') || title.includes('not exist')) {
                        clearInterval(checker); clearTimeout(timer);
                        resolve({status:'404'}); return;
                    }

                    // --- Text Extraction ---
                    const body = doc.body;
                    const ignoreTags = ['SCRIPT','STYLE','NOSCRIPT','SVG','HEADER','FOOTER','NAV'];
                    
                    let extracted = "";
                    let passiveText = "";
                    let isCapturingPassive = false;
                    
                    const walker = doc.createTreeWalker(body, NodeFilter.SHOW_TEXT | NodeFilter.SHOW_ELEMENT, null);
                    while(walker.nextNode()) {
                        const node = walker.currentNode;
                        
                        // 要素
                        if(node.nodeType === Node.ELEMENT_NODE) {
                            if(ignoreTags.includes(node.tagName)) continue;
                            
                            // Passive Capture Start/Stop Logic
                            // Check headers or strong text
                            // Note: Dokkan Wiki structure varies, usually H2 or div.Title etc.
                            // We check textContent of block elements
                            
                            if(node.tagName.match(/^H\d$/) || node.classList.contains('Title') || node.classList.contains('section-header')) {
                                const headerText = node.textContent.trim().toLowerCase();
                                if(headerText.includes('passive skill')) {
                                    isCapturingPassive = true;
                                } else if(isCapturingPassive && (headerText.includes('active skill') || headerText.includes('super attack') || headerText.includes('link') || headerText.includes('stats'))) {
                                    isCapturingPassive = false; // End capture
                                }
                            }

                            if(node.tagName === 'IMG') {
                                const alt = node.getAttribute('alt');
                                if(alt) extracted += ` ${alt} `;
                            }
                            const style = window.getComputedStyle(node);
                            if(style.display !== 'inline') extracted += "\n";
                        }
                        // テキスト
                        else if(node.nodeType === Node.TEXT_NODE) {
                            const p = node.parentElement;
                            if(ignoreTags.includes(p.tagName)) continue;
                            const txt = node.nodeValue.trim();
                            if(txt) {
                                extracted += txt + " ";
                                
                                // Capture Passive Content
                                if(isCapturingPassive) {
                                    // Remove common noise like "Name:" if present inside text node
                                    passiveText += txt.replace(/\s+/g, '');
                                }
                            }
                        }
                    }

                    clearInterval(checker); clearTimeout(timer);

                    const cleanText = extracted.replace(/\n\s*\n/g, '\n').trim();

                    // Passive Signature creation
                    // もしパッシブセクションがうまく特定できない場合(構造違い)、全文ハッシュにフォールバックさせない方が良い
                    // 潔く「空」なら全文比較にするか、あるいは「パッシブなし」として扱うか。
                    // 通常キャラでパッシブなしはあり得ないので、もし空なら抽出失敗の可能性が高いが、
                    // 重複判定用には「空同士」で一致してしまうと危険。
                    // なので、passiveが空なら cleanText を使うことにする（安全策）
                    const signature = (passiveText.length > 10) ? passiveText : cleanText.replace(/\s/g, '');

                    resolve({
                        status: 'success',
                        title: title,
                        name: title,
                        cleanText: cleanText,
                        passiveSignature: signature,
                        formatted: `ID: ${id}\nNAME: ${title}\nURL: ${url}\n\n${cleanText}\n\n`
                    });
                }
            }, 300);
        });
    }

    function updateProgress(current, total) {
        document.getElementById('ddb-count').textContent = `${current}/${total}`;
        const pct = (current/total)*100;
        document.getElementById('ddb-progress').style.width = `${pct}%`;
    }

    function download() {
        const txt = finalResults.join('');
        const blob = new Blob([txt], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `dokkan_v8_strict_${Date.now()}.txt`;
        a.click();
    }
})();