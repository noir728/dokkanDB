<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dokkan Data Manager (Bulk Edition)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- External Data Sources -->
    <script src="./js/categories.js"></script>
    <script src="./js/link_skills.js"></script>

    <style>
        body { font-family: sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .section-content { display: block; }
        .section-content.hidden { display: none; }
        .chevron-icon { transition: transform 0.2s; }
        .section-header[aria-expanded="false"] .chevron-icon { transform: rotate(-90deg); }
        
        /* Suggestion List Styles */
        .suggestions-wrapper { position: relative; }
        .suggestions-list {
            position: absolute;
            bottom: 100%; 
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            max-height: 250px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); 
            display: none;
            margin-bottom: 4px;
        }
        .suggestions-list.show { display: block; }
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f1f5f9; }

        /* Small Action Buttons */
        .action-btn {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.1s;
        }
        .btn-reset { background-color: #e2e8f0; color: #475569; }
        .btn-reset:hover { background-color: #cbd5e1; color: #1e293b; }
        .btn-clear { background-color: #fee2e2; color: #ef4444; }
        .btn-clear:hover { background-color: #fecaca; color: #b91c1c; }

        /* Tool Buttons */
        .tool-btn {
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 4px;
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            transition: all 0.1s;
            white-space: nowrap;
            margin-bottom: 2px;
        }
        .tool-btn:hover {
            background-color: #e2e8f0;
            color: #1e293b;
            transform: translateY(-1px);
        }
        .tool-btn:active { transform: translateY(0); }

        /* Loading Bar */
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-20">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-4 w-full md:w-auto justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="database" class="w-6 h-6"></i>
                <h1 class="text-xl font-bold tracking-tight">Dokkan Data Manager</h1>
            </div>
            <!-- Global Reset Button -->
            <button onclick="resetAll()" class="flex items-center gap-1 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-bold transition-colors md:ml-4" title="全ての入力を初期状態に戻す">
                <i data-lucide="rotate-ccw" class="w-3 h-3"></i> 全リセット
            </button>
        </div>
        <div class="flex bg-blue-700 rounded-lg p-1 w-full md:w-auto justify-center overflow-x-auto">
            <button onclick="switchTab('import')" id="btn-import" class="flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-blue-100 hover:bg-blue-600 flex items-center justify-center gap-1 whitespace-nowrap">
                <i data-lucide="sparkles" class="w-4 h-4"></i> 単体解析
            </button>
            <button onclick="switchTab('bulk')" id="btn-bulk" class="flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-blue-100 hover:bg-blue-600 flex items-center justify-center gap-1 whitespace-nowrap">
                <i data-lucide="layers" class="w-4 h-4"></i> 一括解析
            </button>
            <button onclick="switchTab('input')" id="btn-input" class="flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-white text-blue-700 shadow flex items-center justify-center gap-1 whitespace-nowrap">
                <i data-lucide="edit" class="w-4 h-4"></i> 入力編集
            </button>
            <button onclick="switchTab('preview')" id="btn-preview" class="flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-blue-100 hover:bg-blue-600 flex items-center justify-center gap-1 whitespace-nowrap">
                <i data-lucide="file-text" class="w-4 h-4"></i> 出力
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-6">
        
        <!-- API Settings (Common) -->
        <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-4 mb-6">
            <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('api-settings').classList.toggle('hidden')">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4 text-blue-500"></i> AI解析設定 (Gemini API)
                </h2>
                <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
            </div>
            <div id="api-settings" class="mt-4 hidden space-y-3 border-t pt-3">
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-slate-500">Gemini API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="gemini-key" class="border border-slate-300 rounded px-3 py-1.5 text-sm flex-1" placeholder="AIzaSy...">
                        <button onclick="saveApiKey()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">保存</button>
                    </div>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-slate-500">使用モデル</label>
                    <input type="text" id="gemini-model" class="border border-slate-300 rounded px-3 py-1.5 text-sm" value="gemini-2.0-flash-exp" placeholder="例: gemini-1.5-flash, gemini-2.0-flash-exp">
                </div>
            </div>
        </div>

        <!-- IMPORT TAB (SINGLE) -->
        <div id="tab-import" class="tab-content space-y-6">
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                <div class="mb-4">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-5 h-5 text-blue-600"></i> テキストから単体入力
                    </h2>
                    <p class="text-xs text-slate-500 mt-1">DokkanInfoのURL（ID抽出用）と、Webページでコピーしたテキストを貼り付けてください。</p>
                </div>
                
                <div class="mb-3">
                    <label class="text-xs font-bold text-slate-500 block mb-1">対象URL (ID自動抽出用)</label>
                    <input type="text" id="import-url" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例: https://jpnja.dokkaninfo.com/cards/1032111">
                </div>

                <div class="relative">
                    <textarea id="import-text" rows="10" class="w-full border border-slate-300 rounded-lg p-4 text-xs font-mono focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50" placeholder="ここにテキストを貼り付け..."></textarea>
                    
                    <div id="ai-loading" class="hidden absolute inset-0 bg-white/80 flex flex-col items-center justify-center rounded-lg backdrop-blur-sm">
                        <i data-lucide="loader-2" class="w-8 h-8 text-blue-600 animate-spin mb-2"></i>
                        <span class="text-sm font-bold text-blue-600">AIが解析中...</span>
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button onclick="clearImport()" class="text-xs text-slate-500 hover:text-red-500 flex items-center gap-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> クリア
                    </button>
                    <button onclick="analyzeText()" id="btn-analyze" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-2.5 rounded-lg shadow transition flex items-center gap-2 disabled:opacity-50">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> 解析して入力
                    </button>
                </div>
            </div>
        </div>

        <!-- BULK IMPORT TAB -->
        <div id="tab-bulk" class="tab-content space-y-6">
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                <div class="mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="layers" class="w-5 h-5 text-purple-600"></i> 一括解析モード
                            </h2>
                            <p class="text-xs text-slate-500 mt-1">
                                複数キャラの情報を区切り文字で繋げて貼り付けてください。<br>
                                順次APIを実行し、結果をリスト化します。
                            </p>
                        </div>
                        <div class="bg-purple-50 p-2 rounded border border-purple-100 text-xs">
                             <label class="font-bold text-purple-800 block mb-1">区切り文字</label>
                             <input type="text" id="bulk-delimiter" class="border border-purple-300 rounded px-2 py-1 w-24 text-center font-mono" value="===">
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <textarea id="bulk-text" rows="12" class="w-full border border-slate-300 rounded-lg p-4 text-xs font-mono focus:ring-2 focus:ring-purple-500 outline-none bg-slate-50" placeholder="キャラAの情報...&#10;===&#10;キャラBの情報...&#10;===&#10;キャラCの情報..."></textarea>
                </div>

                <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-xs text-slate-500 flex items-center gap-2">
                        <span>待機時間(秒):</span>
                        <input type="number" id="bulk-delay" class="border rounded px-2 py-1 w-16" value="5" min="2">
                        <span class="text-slate-400">(API制限回避のため)</span>
                    </div>
                    <button onclick="startBulkAnalysis()" id="btn-bulk-start" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-2.5 rounded-lg shadow transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="play" class="w-4 h-4"></i> 一括解析開始
                    </button>
                </div>

                <!-- Progress Area -->
                <div id="bulk-progress-area" class="mt-6 hidden">
                    <div class="flex justify-between text-xs font-bold text-slate-600 mb-1">
                        <span id="bulk-status-text">待機中...</span>
                        <span id="bulk-count">0 / 0</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4 overflow-hidden">
                        <div id="bulk-bar" class="bg-purple-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    
                    <!-- Results List -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <div class="bg-slate-50 px-3 py-2 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-slate-700">解析結果一覧</h3>
                            <button onclick="copyBulkTSV()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-1">
                                <i data-lucide="copy" class="w-3 h-3"></i> 全結果をTSVコピー
                            </button>
                        </div>
                        <div id="bulk-results-container" class="max-h-60 overflow-y-auto bg-white p-2 space-y-1">
                            <!-- Result Items -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INPUT TAB -->
        <div id="tab-input" class="tab-content active space-y-6">
            
            <!-- Character Info Section -->
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                <div class="section-header flex items-center justify-between bg-slate-100 p-3 rounded-t cursor-pointer border-b border-slate-200 hover:bg-slate-200 transition-colors" onclick="toggleSection('basic-content', this)" aria-expanded="true">
                    <div class="flex items-center gap-2 font-bold text-slate-700">
                        <i data-lucide="user" class="w-4 h-4"></i> 基本情報 (Characters.csv)
                    </div>
                    <i data-lucide="chevron-down" class="chevron-icon w-4 h-4"></i>
                </div>
                
                <div id="basic-content" class="section-content p-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Basic Fields -->
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">キャラID (必須)</label>
                        <input type="text" id="char-id" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-yellow-50" placeholder="自動入力または手動">
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">二つ名</label>
                        <input type="text" id="char-title" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="例: 究極の力">
                    </div>
                    
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">キャラ名</label>
                        <div class="flex gap-2">
                            <input type="text" id="char-name" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm flex-1" placeholder="例: 孫悟空">
                            <button onclick="searchWeb()" class="bg-blue-100 text-blue-600 border border-blue-200 rounded px-2 hover:bg-blue-200 text-xs font-bold whitespace-nowrap flex items-center gap-1" title="二つ名とキャラ名でGoogle検索">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">読み仮名</label>
                        <input type="text" id="char-yomi" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="例: そんごくう">
                    </div>

                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">レアリティ</label>
                        <select id="char-rarity" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="SSR">SSR</option>
                            <option value="UR">UR</option>
                            <option value="LR">LR</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">コスト</label>
                        <input type="number" id="char-cost" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">属性</label>
                        <select id="char-type" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="AGL">AGL (速)</option>
                            <option value="TEQ">TEQ (技)</option>
                            <option value="INT">INT (知)</option>
                            <option value="STR">STR (力)</option>
                            <option value="PHY">PHY (体)</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">クラス</label>
                        <select id="char-class" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="Super">Super (超)</option>
                            <option value="Extreme">Extreme (極)</option>
                        </select>
                    </div>

                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">実装日</label>
                        <input type="text" id="char-release" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="YYYY/MM/DD">
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">極限日</label>
                        <input type="text" id="char-eza" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="YYYY/MM/DD">
                    </div>
                    <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">超極限日</label>
                        <input type="text" id="char-seza" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="YYYY/MM/DD">
                    </div>
                     <div class="flex flex-col gap-1 md:col-span-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">入手方法</label>
                        <select id="char-source" class="border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="gasha">ガチャ (gasha)</option>
                            <option value="event">イベント (event)</option>
                            <option value="mission">ミッション (mission)</option>
                            <option value="exchange">交換所 (exchange)</option>
                        </select>
                    </div>

                    <!-- Category Input -->
                    <div class="flex flex-col gap-1 md:col-span-4 suggestions-wrapper">
                        <div class="flex justify-between items-center mb-1">
                             <label class="text-xs font-semibold text-slate-500 uppercase">カテゴリ (カンマ区切り)</label>
                             <div class="flex gap-2">
                                <div class="flex gap-1">
                                    <button class="action-btn btn-reset" onclick="resetField('char-categories', 'categories')">初期値</button>
                                    <button class="action-btn btn-clear" onclick="clearField('char-categories')">クリア</button>
                                </div>
                             </div>
                        </div>
                        <div class="flex gap-2 mb-1">
                            <input type="text" id="cat-search" class="border border-blue-200 rounded px-2 py-1 text-sm flex-1" placeholder="カテゴリを検索して追加 (クリックで一覧表示)...">
                        </div>
                        <div id="cat-suggestions" class="suggestions-list"></div>
                        <textarea id="char-categories" rows="3" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" placeholder="純粋サイヤ人, 孫悟空の系譜, ..."></textarea>
                    </div>

                    <!-- Awakening Input -->
                    <div class="flex flex-col gap-1 md:col-span-4">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">覚醒ルート (JSON)</label>
                            <div class="flex gap-1">
                                <button class="action-btn btn-reset" onclick="resetField('char-awakening', 'awakening')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearField('char-awakening')">クリア</button>
                            </div>
                        </div>
                        <textarea id="char-awakening" rows="12" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono"></textarea>
                    </div>
                    
                     <div class="flex flex-col gap-1 md:col-span-4">
                        <label class="text-xs font-semibold text-slate-500 uppercase">ドロップイベントID (任意)</label>
                        <input type="text" id="char-dropevent" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="">
                    </div>
                </div>
            </div>

            <!-- Leader Skill Section -->
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                 <div class="section-header flex items-center justify-between bg-slate-100 p-3 rounded-t cursor-pointer border-b border-slate-200 hover:bg-slate-200 transition-colors" onclick="toggleSection('leader-content', this)" aria-expanded="true">
                    <div class="flex items-center gap-2 font-bold text-slate-700">
                        <i data-lucide="settings" class="w-4 h-4"></i> リーダースキル
                    </div>
                    <i data-lucide="chevron-down" class="chevron-icon w-4 h-4"></i>
                </div>
                <div id="leader-content" class="section-content p-4 grid grid-cols-1 gap-4">
                     <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">通常</label>
                        <textarea id="ls-normal" rows="2" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono"></textarea>
                    </div>
                     <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">極限後</label>
                        <textarea id="ls-eza" rows="2" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono"></textarea>
                    </div>
                     <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">超極限後</label>
                        <textarea id="ls-seza" rows="2" class="border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono"></textarea>
                    </div>
                </div>
            </div>

            <!-- Forms Section -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-slate-700">形態データ (Forms.csv)</h2>
                    <button onclick="addForm()" class="flex items-center gap-1 bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-sm font-bold shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> 形態追加
                    </button>
                </div>
                
                <div id="forms-container" class="space-y-4">
                    <!-- Form items will be added here via JS -->
                </div>
            </div>

        </div>

        <!-- PREVIEW TAB -->
        <div id="tab-preview" class="tab-content space-y-6">
            <div class="bg-blue-50 p-4 rounded border border-blue-200 flex justify-between items-center">
                 <div>
                     <p class="font-bold text-blue-800 text-sm">出力形式を選択</p>
                     <p class="text-xs text-blue-600">スプレッドシートへの貼り付け方で選んでください</p>
                 </div>
                 <div class="flex bg-white rounded border border-blue-200 p-1">
                     <button onclick="setOutputMode('csv')" id="mode-csv" class="px-3 py-1 text-xs font-bold rounded bg-blue-100 text-blue-700">CSV (ファイル保存)</button>
                     <button onclick="setOutputMode('tsv')" id="mode-tsv" class="px-3 py-1 text-xs font-bold rounded text-slate-500">TSV (スプシ直貼り)</button>
                 </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-4 h-4"></i> Characters 出力
                </h3>
                <div class="relative">
                    <pre id="output-char" class="bg-slate-800 text-slate-100 p-3 rounded text-xs overflow-x-auto whitespace-pre-wrap font-mono"></pre>
                    <button onclick="copyToClipboard('output-char', this)" class="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white p-1.5 rounded flex items-center gap-1 text-xs">
                        <i data-lucide="copy" class="w-3 h-3"></i> コピー
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-4 h-4"></i> Forms 出力
                </h3>
                <div class="relative">
                    <pre id="output-forms" class="bg-slate-800 text-slate-100 p-3 rounded text-xs overflow-x-auto whitespace-pre-wrap font-mono"></pre>
                    <button onclick="copyToClipboard('output-forms', this)" class="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white p-1.5 rounded flex items-center gap-1 text-xs">
                         <i data-lucide="copy" class="w-3 h-3"></i> コピー
                    </button>
                </div>
            </div>
            
             <div class="bg-yellow-50 p-4 rounded border border-yellow-200 text-sm text-yellow-800">
              <p class="font-bold mb-1">TSVモード（スプシ直貼り）の使い方</p>
              <ul class="list-disc pl-5 space-y-1 text-xs">
                <li>上のボタンを「TSV」に切り替えてコピーします。</li>
                <li>スプレッドシートの貼り付けたいセルを選択し、<b>Ctrl + V</b> で貼り付けます。</li>
                <li>「ファイル > インポート」や「区切り位置指定」は不要で、自動的にセルに分割されます。</li>
              </ul>
            </div>
        </div>

    </main>

    <!-- Template for Form Item -->
    <template id="form-template">
        <div class="form-item bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden" data-id="">
            <div class="bg-slate-50 p-3 border-b border-slate-200 flex justify-between items-center">
                 <div class="flex gap-2 items-center">
                    <span class="form-index bg-slate-200 text-slate-600 px-2 py-0.5 rounded text-xs font-bold">#1</span>
                    <input type="text" class="form-label-input font-bold text-slate-700 bg-transparent border-b border-transparent focus:border-blue-500 focus:outline-none w-32" placeholder="タブ名" value="通常">
                 </div>
                 <div class="flex items-center gap-2">
                    <button class="btn-duplicate text-blue-500 hover:text-blue-700 text-xs font-bold flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-50" title="この形態をコピーして追加">
                        <i data-lucide="copy" class="w-3 h-3"></i> コピー
                    </button>
                    <div class="w-px h-4 bg-slate-300"></div>
                    <button class="btn-remove text-red-400 hover:text-red-600" title="削除">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                 </div>
            </div>

            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Form Basic Fields -->
                <div class="grid grid-cols-2 gap-4 md:col-span-2">
                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">状態 (mode)</label>
                        <select class="form-mode border border-slate-300 rounded px-2 py-1.5 text-sm bg-white">
                            <option value="normal">normal</option>
                            <option value="eza">eza</option>
                            <option value="seza">seza</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                         <label class="text-xs font-semibold text-slate-500 uppercase">形態名称 (変わる場合)</label>
                         <input type="text" class="form-name border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">画像ID (form_id)</label>
                        <input type="text" class="form-id-val border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="空欄ならキャラID">
                    </div>
                    
                    <div class="flex flex-col gap-1 md:col-span-2 suggestions-wrapper">
                        <label class="text-xs font-semibold text-slate-500 uppercase">リンクスキル (カンマ区切り)</label>
                        <div class="flex gap-2 mb-1">
                            <input type="text" class="link-search border border-blue-200 rounded px-2 py-1 text-sm flex-1" placeholder="リンクを検索して追加 (クリックで一覧表示)...">
                        </div>
                        <div class="link-suggestions suggestions-list"></div>
                        <input type="text" class="form-links border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                </div>

                <!-- Form JSON Fields -->
                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                   <!-- Stats (Full Width) -->
                   <div class="flex flex-col gap-1 md:col-span-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">ステータス (Stats JSON)</label>
                            <div class="flex gap-1">
                                <button class="action-btn btn-reset" onclick="resetFormItem(this, 'stats')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearFormItem(this, '.form-stats')">クリア</button>
                            </div>
                        </div>
                        <textarea class="form-stats border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" rows="3"></textarea>
                   </div>

                   <!-- Attacks (Row 2 Col 1) -->
                   <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">必殺技 (Attacks JSON)</label>
                            <div class="flex gap-1 items-center">
                                <button class="action-btn btn-reset" onclick="resetFormItem(this, 'attacks')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearFormItem(this, '.form-attacks')">クリア</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1 justify-end items-center mb-1">
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'crit: &quot;100%&quot;,')">会心</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'add: &quot;5回&quot;,')">追撃</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'reduce: &quot;90%&quot;,')">軽減</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'dodge: &quot;50%&quot;,')">回避</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'guard: true,')">ガード</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'effective: true,')">抜群</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'action_break: true,')">弾き</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'revival: true,')">復活</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'stun: true,')">気絶</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'seal: true,')">封じ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'counter: true,')">反撃</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'survive_ko: true,')">KO耐</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'target: true,')">タゲ集中</button>
                             
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'atk_up: &quot;%&quot;,')">ATKアップ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'def_up: &quot;%&quot;,')">DEFアップ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'atk_down: &quot;%&quot;,')">ATKダウン</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-attacks', 'def_down: &quot;%&quot;,')">DEFダウン</button>
                        </div>
                        <textarea class="form-attacks border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" rows="7"></textarea>
                   </div>
                   
                   <!-- Active (Row 2 Col 2) -->
                   <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center mb-1">
                             <label class="text-xs font-semibold text-slate-500 uppercase">アクティブスキル (Active JSON)</label>
                             <div class="flex gap-1">
                                <button class="action-btn btn-reset" onclick="resetFormItem(this, 'active')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearFormItem(this, '.form-active')">クリア</button>
                             </div>
                        </div>
                        <div class="flex flex-wrap gap-1 justify-end items-center mb-1">
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'crit: &quot;100%&quot;,')">会心</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'add: &quot;5回&quot;,')">追撃</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'reduce: &quot;90%&quot;,')">軽減</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'dodge: &quot;50%&quot;,')">回避</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'guard: true,')">ガード</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'effective: true,')">抜群</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'action_break: true,')">弾き</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'revival: true,')">復活</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'stun: true,')">気絶</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'seal: true,')">封じ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'counter: true,')">反撃</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'survive_ko: true,')">KO耐</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'target: true,')">タゲ集中</button>
                             
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'atk_up: &quot;%&quot;,')">ATKアップ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'def_up: &quot;%&quot;,')">DEFアップ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'atk_down: &quot;%&quot;,')">ATKダウン</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-active', 'def_down: &quot;%&quot;,')">DEFダウン</button>
                        </div>
                        <textarea class="form-active border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" rows="7"></textarea>
                   </div>
                   
                   <!-- Passive (Row 3, Full Width) -->
                   <div class="flex flex-col gap-1 md:col-span-2 passive-wrapper">
                        <div class="flex items-center justify-between mb-1">
                             <label class="text-xs font-semibold text-slate-500 uppercase">パッシブスキル (Passive JSON)</label>
                             <div class="flex gap-1">
                                <button class="action-btn btn-reset" onclick="resetFormItem(this, 'passive')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearFormItem(this, '.form-passive')">クリア</button>
                             </div>
                        </div>
                        <div class="flex flex-wrap gap-1 justify-end items-center mb-1">
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'crit: &quot;100%&quot;,')">会心</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'add: &quot;5回&quot;,')">追撃</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'reduce: &quot;90%&quot;,')">軽減</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'dodge: &quot;50%&quot;,')">回避</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'guard: true,')">ガード</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'effective: true,')">抜群</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'action_break: true,')">弾き</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'revival: true,')">復活</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'stun: true,')">気絶</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'seal: true,')">封じ</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'counter: true,')">反撃</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'survive_ko: true,')">KO耐</button>
                             <button class="tool-btn" onclick="insertText(this, '.form-passive', 'target: true,')">タゲ集中</button>
                        </div>
                        <textarea class="form-passive border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" rows="12"></textarea>
                   </div>

                   <!-- Standby -->
                   <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center mb-1">
                             <label class="text-xs font-semibold text-slate-500 uppercase">スタンバイスキル (Standby JSON)</label>
                             <div class="flex gap-1">
                                <button class="action-btn btn-reset" onclick="resetFormItem(this, 'standby')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearFormItem(this, '.form-standby')">クリア</button>
                             </div>
                        </div>
                        <textarea class="form-standby border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" rows="3"></textarea>
                   </div>

                   <!-- Field -->
                   <div class="flex flex-col gap-1">
                        <div class="flex justify-between items-center mb-1">
                             <label class="text-xs font-semibold text-slate-500 uppercase">フィールド (Field JSON)</label>
                             <div class="flex gap-1">
                                <button class="action-btn btn-reset" onclick="resetFormItem(this, 'field')">初期値</button>
                                <button class="action-btn btn-clear" onclick="clearFormItem(this, '.form-field')">クリア</button>
                             </div>
                        </div>
                        <textarea class="form-field border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono" rows="3"></textarea>
                   </div>
                   
                   <div class="flex flex-col gap-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase">リバーシブル (Reversible)</label>
                        <input type="text" class="form-reversible border border-slate-300 rounded px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="例: normal">
                   </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Check API Key
            const key = localStorage.getItem('gemini_api_key');
            if(key) document.getElementById('gemini-key').value = key;
            const model = localStorage.getItem('gemini_model');
            if(model) document.getElementById('gemini-model').value = model;

            // Load resources
            if (typeof MASTER_CATEGORIES !== 'undefined') {
                availableCategories = MASTER_CATEGORIES;
            }
            if (typeof LINK_SKILLS !== 'undefined') {
                availableLinks = Object.keys(LINK_SKILLS);
            }

            addForm(); 
            document.getElementById('char-awakening').value = DEFAULTS.awakening;
            setupTagSearch('cat-search', 'cat-suggestions', 'char-categories', availableCategories);
        });

        // --- AI API Settings ---
        function saveApiKey() {
            const key = document.getElementById('gemini-key').value.trim();
            const model = document.getElementById('gemini-model').value.trim();
            if(!key) {
                alert("APIキーを入力してください");
                return;
            }
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model || 'gemini-2.0-flash-exp');
            alert("設定を保存しました");
            document.getElementById('api-settings').classList.add('hidden');
        }

        function clearImport() {
            document.getElementById('import-text').value='';
            document.getElementById('import-url').value='';
        }

        // --- BULK ANALYSIS LOGIC ---
        let bulkQueue = [];
        let bulkResults = [];
        let isBulkRunning = false;
        
        async function startBulkAnalysis() {
            const text = document.getElementById('bulk-text').value.trim();
            const delimiter = document.getElementById('bulk-delimiter').value || '===';
            const delaySec = parseInt(document.getElementById('bulk-delay').value) || 5;
            const apiKey = localStorage.getItem('gemini_api_key');
            
            if(!text) { alert("一括解析用のテキストを入力してください"); return; }
            if(!apiKey) { alert("APIキーを設定してください"); return; }
            
            // Split and setup queue
            bulkQueue = text.split(new RegExp(`\\n?${delimiter}\\n?`)).map(t => t.trim()).filter(t => t);
            if(bulkQueue.length === 0) { alert("区切り文字で正しく分割できませんでした"); return; }

            // UI Reset
            isBulkRunning = true;
            bulkResults = []; // Clear previous results
            document.getElementById('bulk-results-container').innerHTML = '';
            document.getElementById('btn-bulk-start').disabled = true;
            document.getElementById('btn-bulk-start').innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 解析中...`;
            
            document.getElementById('bulk-progress-area').classList.remove('hidden');
            updateBulkProgress(0, bulkQueue.length);

            // Start Loop
            for (let i = 0; i < bulkQueue.length; i++) {
                if(!isBulkRunning) break; // Emergency stop if needed

                updateBulkStatus(`キャラ ${i+1}/${bulkQueue.length} を解析中...`);
                
                try {
                    const chunk = bulkQueue[i];
                    // Call API (using the same logic as single, but returning data)
                    const data = await fetchAiAnalysis(chunk, apiKey);
                    
                    // Store Result
                    bulkResults.push({
                        status: 'success',
                        data: data,
                        originalText: chunk.substring(0, 30) + "..."
                    });
                    addBulkResultItem(i, 'success', data.basics?.name || '不明なキャラ');

                } catch (e) {
                    console.error(e);
                    bulkResults.push({
                        status: 'error',
                        error: e.message,
                        originalText: bulkQueue[i].substring(0, 30) + "..."
                    });
                    addBulkResultItem(i, 'error', `エラー: ${e.message}`);
                }

                updateBulkProgress(i+1, bulkQueue.length);

                // Wait for delay (skip on last item)
                if (i < bulkQueue.length - 1) {
                    let wait = delaySec;
                    while(wait > 0) {
                         updateBulkStatus(`待機中... 残り${wait}秒`);
                         await new Promise(r => setTimeout(r, 1000));
                         wait--;
                    }
                }
            }

            // Finish
            isBulkRunning = false;
            updateBulkStatus("解析完了！");
            document.getElementById('btn-bulk-start').disabled = false;
            document.getElementById('btn-bulk-start').innerHTML = `<i data-lucide="play" class="w-4 h-4"></i> 一括解析開始`;
            alert("一括解析が完了しました。\n「全結果をTSVコピー」で出力できます。");
        }

        async function fetchAiAnalysis(text, apiKey) {
             const model = localStorage.getItem('gemini_model') || 'gemini-2.0-flash-exp';
             // Shortened prompt for efficiency, same rules
             const prompt = `
あなたはドッカンバトルのデータ抽出を行う専門AIです。
以下のテキストはWebページからコピーされたキャラクター情報です。これを解析し、指定のJSON形式で出力してください。

【最重要指示】
1. **JSONのみを出力**: Markdown記法(\`\`\`json)は不要です。純粋なJSON文字列のみを返してください。
2. **NULLの扱い**: データが存在しない場合、"なし"という文字列ではなく、必ず JSONの \`null\` または空文字 \`""\` を使用してください。
   - 例: EZA日が不明なら "eza_date": null

【詳細抽出ルール】
1. **ステータス**: "最大", "解放", "100%", "虹" などの数値ではなく、**「0%」「解放なし」「Lv最大時（潜在解放なし）」のステータス**を優先してください。
2. **パッシブスキル構造**:
   - **分割**: パッシブスキルは複数の効果ブロックに分かれていることが多いです。空白行や短い見出し行を目印に分割してください。
   - **見出し(title)**: ブロックの最初の行が見出しである場合が多いです（例：「基本効果」「〇〇カテゴリがある時」など）。
   - **効果(effects)**: 効果文は改行ごとに配列に分割してください。
   - **置換**:
     - "up" → "[img:up]"
     - "once" → "[img:one_time]"
     - "forever" → "[img:infinity]"
     - "down" → "[img:down]"
   - **登場時演出(intro)**: "登場時"という文言を含む効果は、\`intro\` オブジェクトに分離してください。

3. **必殺技(Attacks)**:
   - **ki**: テキストから推測してください。通常は "12~"、超必殺技は "18~" です。
   - **maxLv**: レアリティから推測してください（UR=10, LR=20, 極限UR=15, 極限LR=25）。不明なら数値を入れず null にしてください。
   - **type**: 技の説明やアイコンの文脈から推測してください（"格闘"、"気弾"、"物理"、"その他"）。不明なら "気弾,格闘,物理" としてください。
   - **効果文**: 改行は "、" に置換して1行にまとめてください。

4. **スペック自動抽出 (specs / maxValues)**:
   - テキストを解析し、以下のキーワードが含まれる場合、フラグを立ててください。
   - **パッシブスキルの場合**: \`maxValues\` オブジェクトに入れてください。
   - **必殺技・アクティブスキルの場合**: \`specs\` オブジェクトに入れてください。
     - 気絶 → "stun": true
     - 必殺技封じ → "seal": true
     - 会心 → "crit": "%" (例: "50%")
     - 回避 → "dodge": "%"
     - ダメージ軽減 → "reduce": "%"
     - 全属性に効果抜群 → "effective": true
     - ガード → "guard": true
     - 必殺技を見極める → "scouter": true
     - 復活 → "revival": true
     - アクションブレイク/行動無効 → "action_break": true
     - 攻撃する相手が気絶/封じ状態 → "target": true (特攻)
     - 必殺技追撃 → "add": "回"
     - **ATK上昇/DEF上昇 (必殺・アクティブのみ)**:
        - "超大幅上昇" → "atk_up": "100%" / "def_up": "100%"
        - "大幅上昇" → "atk_up": "50%" / "def_up": "50%"
        - 単なる"上昇" → "atk_up": "30%" / "def_up": "30%"
     - **ATK低下/DEF低下 (必殺・アクティブのみ)**:
        - "大幅低下" → "atk_down": "30%" / "def_down": "30%"
        - 単なる"低下" → "atk_down": "20%" / "def_down": "20%"


【出力JSON構造】
{
  "basics": {
    "id": "キャラID(数値)",
    "name": "キャラ名",
    "title": "二つ名",
    "rarity": "レアリティ(SSR, UR, LR)",
    "type": "属性(AGL, TEQ, INT, STR, PHY)",
    "class": "クラス(SuperまたはExtreme)",
    "cost": 数値,
    "release_date": "YYYY/MM/DD",
    "eza_date": "YYYY/MM/DD (なければnull)",
    "categories": ["カテゴリ名1", "カテゴリ名2"]
  },
  "forms": [
    {
      "name": "形態名 (基本形態/変身後名)",
      "stats": { "hp": 数値, "atk": 数値, "def": 数値 }, 
      "leader_skill": "リーダースキル全文",
      "passive": {
        "name": "パッシブ名",
        "intro": {"condition": "登場時演出条件","effect": "効果"}(なければnull),
        "details": [
           { "title": "見出し", "effects": ["効果文"] }
        ],
        "maxValues": {} 
      },
      "active": {
        "name": "アクティブ名",
        "condition": "条件",
        "description": "効果",
        "specs": {}
      },
      "standby": {
        "name": "スタンバイ名",
        "condition": "条件",
        "effect": "スタンバイ中の効果",
        "finish": [
           { "type": "チャージフィニッシュ/復活カウンター", "name": "フィニッシュ名", "condition": "条件", "effect": "効果" }
        ]
      },
      "attacks": [
        { 
          "ki": "12~", 
          "maxLv": 10, 
          "type": "気弾/格闘/物理", 
          "name": "技名", 
          "effect": "効果",
          "specs": {}
        }
      ],
      "links": ["リンク名1", "リンク名2"]
    }
  ]
}

対象テキスト:
${text.substring(0, 30000)}
`;
             const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            if (!response.ok) throw new Error("API Request Failed");
            const json = await response.json();
            const raw = json.candidates[0].content.parts[0].text;
            return JSON.parse(raw.replace(/```json|```/g, '').trim());
        }

        function updateBulkProgress(current, total) {
            const pct = Math.round((current / total) * 100);
            document.getElementById('bulk-bar').style.width = `${pct}%`;
            document.getElementById('bulk-count').textContent = `${current} / ${total}`;
        }
        function updateBulkStatus(msg) {
            document.getElementById('bulk-status-text').textContent = msg;
        }
        function addBulkResultItem(index, status, title) {
            const container = document.getElementById('bulk-results-container');
            const div = document.createElement('div');
            div.className = "flex justify-between items-center text-xs p-2 border-b border-slate-100 last:border-0";
            
            const icon = status === 'success' 
                ? `<i data-lucide="check-circle-2" class="w-4 h-4 text-green-500"></i>`
                : `<i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>`;
            
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    ${icon}
                    <span class="font-mono text-slate-400">#${index+1}</span>
                    <span class="font-bold text-slate-700 truncate w-64">${title}</span>
                </div>
                ${status === 'success' ? `<button onclick="loadBulkItem(${index})" class="text-blue-600 hover:underline">編集</button>` : ''}
            `;
            container.appendChild(div);
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }

        // Load a single bulk result into the editor
        function loadBulkItem(index) {
            if(!bulkResults[index] || bulkResults[index].status !== 'success') return;
            if(!confirm("現在の入力内容を破棄して、このデータを読み込みますか？")) return;
            
            applyAiData(bulkResults[index].data);
            switchTab('input');
        }

        // Generate TSV for ALL bulk results
        function copyBulkTSV() {
            if(bulkResults.length === 0) { alert("データがありません"); return; }
            
            let charRows = [];
            let formRows = [];
            
            bulkResults.forEach(res => {
                if(res.status !== 'success') return;
                const data = res.data;
                const basics = data.basics || data;
                const forms = data.forms || [data];
                
                // Char Row
                const charId = basics.id || '';
                charRows.push([
                    charId, basics.title, basics.name, basics.title, // yomi placeholder?
                    basics.rarity, basics.cost, basics.type, basics.class,
                    basics.release_date, basics.eza_date, "", // seza
                    // Leader skills (first form usually)
                    forms[0]?.leader_skill || "", "", "",
                    formatField((basics.categories||[]).join(', '), 'tsv'),
                    formatField(DEFAULTS.awakening, 'tsv'), // default awakening
                    "", ""
                ].join('\t'));

                // Form Rows
                forms.forEach(f => {
                    // Logic to fix attacks data similar to applyAiData
                    let attacksJson = "";
                    if(f.attacks) {
                        const rarity = basics.rarity || 'UR';
                        const fixedAttacks = f.attacks.map((atk, i) => ({
                            ki: atk.ki || (rarity==='LR' && i===1 ? "18~" : "12~"),
                            maxLv: atk.maxLv || (rarity==='LR'?20:10),
                            type: atk.type || "気弾,格闘,物理",
                            name: atk.name,
                            effect: atk.effect,
                            specs: atk.specs||{}
                        }));
                        attacksJson = JSON.stringify(fixedAttacks);
                    }
                    
                    // Logic for passive
                    let passiveJson = "";
                    if(f.passive) {
                         const p = {
                            name: f.passive.name || "パッシブ",
                            intro: f.passive.intro || null,
                            details: f.passive.details || [],
                            maxValues: f.passive.maxValues || f.passive.specs || {}
                        };
                        passiveJson = JSON.stringify(p);
                    }

                    formRows.push([
                        charId, "normal", "通常", f.name || "", "",
                        formatField((f.links||[]).join(', '), 'tsv'),
                        formatField(JSON.stringify(f.stats), 'tsv'),
                        formatField(attacksJson, 'tsv'),
                        formatField(passiveJson, 'tsv'),
                        formatField(JSON.stringify(f.active||{}), 'tsv'),
                        formatField(JSON.stringify(f.standby||{}), 'tsv'),
                        formatField(JSON.stringify(f.field||{}), 'tsv'),
                        "normal"
                    ].join('\t'));
                });
            });
            
            // For now, let's copy Forms data as it's most complex. 
            // Or combine? Let's copy Forms data primarily as requested implies bulk entry.
            // Actually, let's just copy Forms. User can loop for Chars if needed or we can append.
            // Let's copy Forms data to clipboard.
            const finalText = formRows.join('\n');
            navigator.clipboard.writeText(finalText).then(() => {
                alert("全キャラの「Forms」データをTSV形式でクリップボードにコピーしました。\nスプレッドシートに貼り付けてください。");
            });
        }


        // --- SINGLE AI Analysis Logic ---
        async function analyzeText() {
            const text = document.getElementById('import-text').value.trim();
            const urlVal = document.getElementById('import-url').value.trim();
            const apiKey = localStorage.getItem('gemini_api_key');
            
            // ... (Existing Single Logic) ...
            // Reusing fetchAiAnalysis for consistency
            if (!text) { alert("解析するテキストを入力してください"); return; }
            if (!apiKey) { alert("API設定からAPIキーを保存してください"); document.getElementById('api-settings').classList.remove('hidden'); return; }

            let extractedId = null;
            if(urlVal) {
                const match = urlVal.match(/cards\/(\d+)/);
                if(match) extractedId = match[1];
            }

            const btn = document.getElementById('btn-analyze');
            const loader = document.getElementById('ai-loading');
            btn.disabled = true;
            loader.classList.remove('hidden');

            try {
                const result = await fetchAiAnalysis(text, apiKey);
                if(extractedId) {
                    if(result.basics) result.basics.id = extractedId;
                    else result.id = extractedId;
                }
                applyAiData(result);
                alert("解析成功！データを入力しました。\n入力編集タブで確認してください。");
                switchTab('input');
            } catch (e) {
                console.error(e);
                alert("AI解析エラー: " + e.message);
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        // ... (Existing applyAiData and other functions remain same, just ensure they are present) ...
        
        function applyAiData(data) {
            // Support both flat structure (legacy prompt) and new nested structure
            const basics = data.basics || data; 
            const forms = data.forms || [data]; 

            // Basic Info
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                if(el && val) el.value = val;
            };

            setVal('char-id', basics.id);
            setVal('char-name', basics.name);
            setVal('char-title', basics.title);
            setVal('char-cost', basics.cost);
            setVal('char-rarity', basics.rarity);
            setVal('char-type', basics.type);
            setVal('char-class', basics.class);
            setVal('char-release', basics.release_date);
            
            // EZA Date handling (Strict null check)
            if (basics.eza_date && basics.eza_date !== 'なし') {
                setVal('char-eza', basics.eza_date);
            }

            if (basics.categories && Array.isArray(basics.categories)) {
                setVal('char-categories', basics.categories.join(', '));
            }

            // Forms Handling
            const formContainer = document.getElementById('forms-container');
            formContainer.innerHTML = '';
            
            forms.forEach((formData, index) => {
                addForm(); // Adds a new form item
                const formItems = formContainer.querySelectorAll('.form-item');
                const currentForm = formItems[formItems.length - 1];
                
                // Set Form Name
                if (index > 0 && formData.name) {
                    currentForm.querySelector('.form-name').value = formData.name;
                }

                // Stats
                if (formData.stats) {
                    currentForm.querySelector('.form-stats').value = JSON.stringify(formData.stats, null, 2);
                }

                // Links
                if (formData.links && Array.isArray(formData.links)) {
                    currentForm.querySelector('.form-links').value = formData.links.join(', ');
                }

                // Leader
                if (index === 0 && formData.leader_skill) {
                    setVal('ls-normal', formData.leader_skill);
                }

                // Passive (New Structure)
                if (formData.passive) {
                    const p = {
                        name: formData.passive.name || "パッシブ",
                        // AI often puts intro in details or top level, support both
                        intro: formData.passive.intro || { condition: "", effect: "" },
                        details: formData.passive.details || [{ title: "効果", effects: [""] }],
                        maxValues: formData.passive.maxValues || formData.passive.specs || {}, // Map specs to maxValues
                        // specs: formData.passive.specs || {} // No longer using specs for passive
                    };
                    // Clean null intro
                    if (!p.intro || (!p.intro.condition && !p.intro.effect)) {
                        p.intro = null; // Set explicit null for JSON
                    }
                    currentForm.querySelector('.form-passive').value = JSON.stringify(p, null, 2);
                }

                // Active
                if (formData.active && formData.active.name) {
                    const a = {
                        name: formData.active.name,
                        condition: formData.active.condition || "",
                        effect: formData.active.description || "",
                        specs: formData.active.specs || {}
                    };
                    currentForm.querySelector('.form-active').value = JSON.stringify(a, null, 2);
                } else {
                    // Empty field if no Active
                    currentForm.querySelector('.form-active').value = "";
                }

                // Standby
                if (formData.standby && (formData.standby.name || formData.standby.condition)) {
                    let finishArray = [];
                    if (formData.standby.finish && Array.isArray(formData.standby.finish)) {
                        finishArray = formData.standby.finish;
                    }
                    const s = {
                        name: formData.standby.name || "スタンバイ",
                        condition: formData.standby.condition || "",
                        effect: formData.standby.effect || "", 
                        finish: finishArray
                    };
                    currentForm.querySelector('.form-standby').value = JSON.stringify(s, null, 2);
                } else {
                    // Empty field if no Standby
                    currentForm.querySelector('.form-standby').value = "";
                }

                // Field
                if (formData.field) {
                    currentForm.querySelector('.form-field').value = JSON.stringify(formData.field, null, 2);
                } else {
                     // Empty field if no Field (AI logic currently doesn't output field much, but safely clear it)
                     currentForm.querySelector('.form-field').value = "";
                }

                // Attacks (New Logic)
                if (formData.attacks && Array.isArray(formData.attacks)) {
                    // Logic to guess maxLv if AI failed
                    const guessMaxLv = (rarity, type) => {
                        if (rarity === 'LR') return 20;
                        if (rarity === 'UR') return 10;
                        return 10;
                    };
                    const rarity = basics.rarity || 'UR';

                    const attacksData = formData.attacks.map((atk, i) => {
                        // Guess Ki if missing
                        let ki = atk.ki;
                        if (!ki) {
                           if (rarity === 'LR' && i === 1) ki = "18~";
                           else ki = "12~";
                        }
                        
                        // Guess MaxLv if missing
                        let maxLv = atk.maxLv;
                        if (!maxLv) maxLv = guessMaxLv(rarity);

                        // Guess Type if missing
                        let type = atk.type;
                        if (!type || type === "気弾,格闘,物理") type = "気弾,格闘,物理"; // Keep default if generic

                        return {
                            ki: ki,
                            maxLv: maxLv,
                            type: type,
                            name: atk.name,
                            effect: atk.effect,
                            specs: atk.specs || {}
                        };
                    });
                    currentForm.querySelector('.form-attacks').value = JSON.stringify(attacksData, null, 2);
                }
            });
        }

        // --- Data Variables ---
        let availableCategories = [];
        let availableLinks = [];
        let outputMode = 'csv'; // 'csv' or 'tsv'

        function setOutputMode(mode) {
            outputMode = mode;
            const btnCsv = document.getElementById('mode-csv');
            const btnTsv = document.getElementById('mode-tsv');
            
            if (mode === 'csv') {
                btnCsv.classList.add('bg-blue-100', 'text-blue-700');
                btnCsv.classList.remove('text-slate-500');
                btnTsv.classList.remove('bg-blue-100', 'text-blue-700');
                btnTsv.classList.add('text-slate-500');
            } else {
                btnTsv.classList.add('bg-blue-100', 'text-blue-700');
                btnTsv.classList.remove('text-slate-500');
                btnCsv.classList.remove('bg-blue-100', 'text-blue-700');
                btnCsv.classList.add('text-slate-500');
            }
            generateCSV();
        }

        // --- Default JSON Templates ---
        const DEFAULTS = {
            awakening: `[
    { rank: "SSR", id: 1000000}, // 1段階目 (SSR)
    { 
        rank: "UR", id: 1000000, 
        medals: [{name:"超激戦/名前/1", bg: "超激戦/bg", count:}] // URへの覚醒メダル
    },
    { 
        rank: "LR", id: 1000000, 
        medals: [{name:"超激戦/名前/", bg: "超激戦/bg", count:}, {name:"超激戦/名前/", bg: "超激戦/bg", count:}] // LRへの覚醒メダル
    },
    { 
        rank: "EZA", id: 1000000, // 極限Z覚醒
        medals: [{name:"zb/名前/", count:}]
    },
    { 
        rank: "SEZA", id: 1000000, // 超極限Z覚醒
        medals: [{name:"zb/名前/5", count:30}]
    }
]`,
            categories: '',
            // Flat structure as requested
            stats: JSON.stringify({ "hp": 10000, "atk": 10000, "def": 10000 }, null, 2),
            
            attacks: `[
    { 
        ki: "12~", maxLv: 20, type: "気弾,格闘,物理", 
        name: "", 
        effect: "",
        "specs": {
        
        }
    },
    { 
        ki: "18~", maxLv: 20, type: "気弾,格闘,物理", 
        name: "", 
        effect: "",
        "specs": {
        
        }
    }
]`,
            passive: `{
    name: "パッシブ",
    // 登場時演出 (なければ intro: null または削除)
    intro: {
        condition: "登場時演出条件",
        effect: "効果"
    },
    // 詳細効果 (箇条書き)
    details: [
        {
            title: "基本効果",
            effects: ["ATK/DEF70%[img:up]"]
        },
        {
            title: "",
            effects: [""]
        }
    ],
    maxValues: {
    
    }
}`,
            active: `{
    name: "",
    condition: "",
    effect: "",
    "specs": {
    
    }
}`,
            standby: `{
    name: "スタンバイ名",
    condition: "条件",
    effect: "効果",
    finish: [
        { type: "チャージフィニッシュ", name: "フィニッシュ名", condition: "条件", effect: "効果" },
        { type: "復活カウンター", name: "フィニッシュ名", condition: "条件", effect: "効果" }
    ]
}`,
            field: `{
    name: "フィールド名",
    icon: "field_Button",
    condition: "条件",
    effect: "効果"
}`
        };

        // --- Web Search ---
        function searchWeb() {
            const title = document.getElementById('char-title').value;
            const name = document.getElementById('char-name').value;
            
            if (!name) {
                alert("検索するにはキャラ名を入力してください");
                return;
            }
            
            const query = `ドッカンバトル ${title} ${name} ステータス`;
            const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            window.open(url, '_blank');
        }

        // --- Global Reset ---
        function resetAll() {
            if(!confirm("現在の入力内容をすべて破棄して、初期状態に戻しますか？")) return;
            
            const fields = [
                'char-id', 'char-title', 'char-name', 'char-yomi', 
                'char-cost', 'char-release', 'char-eza', 'char-seza', 
                'char-dropevent', 'ls-normal', 'ls-eza', 'ls-seza', 'char-categories'
            ];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            document.getElementById('char-rarity').value = 'SSR';
            document.getElementById('char-type').value = 'AGL';
            document.getElementById('char-class').value = 'Super';
            document.getElementById('char-source').value = 'gasha';
            
            document.getElementById('char-awakening').value = DEFAULTS.awakening;
            document.getElementById('import-text').value = '';
            
            const formContainer = document.getElementById('forms-container');
            formContainer.innerHTML = '';
            addForm();
        }

        // --- Individual Field Controls ---
        function clearField(id) {
            const el = document.getElementById(id);
            if(el) el.value = '';
        }
        function resetField(id, defaultKey) {
            const el = document.getElementById(id);
            if(el && DEFAULTS[defaultKey] !== undefined) {
                el.value = DEFAULTS[defaultKey];
            }
        }
        function clearFormItem(btn, selector) {
            const wrapper = btn.closest('.md\\:col-span-2') || btn.closest('.flex-col');
            const el = wrapper.querySelector(selector);
            if(el) el.value = '';
        }
        function resetFormItem(btn, defaultKey) {
            const container = btn.closest('.md\\:col-span-2') || btn.closest('.flex-col');
            const selectorMap = {
                'stats': '.form-stats',
                'attacks': '.form-attacks',
                'passive': '.form-passive',
                'active': '.form-active',
                'standby': '.form-standby',
                'field': '.form-field'
            };
            const el = container.querySelector(selectorMap[defaultKey]);
            if(el && DEFAULTS[defaultKey] !== undefined) {
                el.value = DEFAULTS[defaultKey];
            }
        }

        // --- Generic Text Insertion ---
        // Used for Passive, Attacks, and Active skill buttons
        function insertText(btn, selector, textToInsert) {
            // Find the container holding both the button toolbar and the textarea
            const container = btn.closest('.flex-col');
            const textarea = container.querySelector(selector);
            
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end, text.length);
            
            const insertion = textToInsert + '\n';
            textarea.value = before + insertion + after;
            textarea.selectionStart = textarea.selectionEnd = start + insertion.length;
            textarea.focus();
        }

        // --- Search Logic ---
        function setupTagSearch(inputId, listId, targetId, dataSource) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const target = document.getElementById(targetId);

            if(!input) return;

            const showList = (filterText = '') => {
                const val = filterText.toLowerCase();
                let matches;
                if (!val) {
                    matches = dataSource;
                } else {
                    matches = dataSource.filter(item => item.toLowerCase().includes(val));
                }
                renderSuggestions(matches, list, input, target);
            };

            input.addEventListener('input', (e) => showList(e.target.value));
            input.addEventListener('focus', () => showList(input.value));
            input.addEventListener('click', () => showList(input.value));
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.suggestions-wrapper')) {
                    list.classList.remove('show');
                }
            });
        }

        function renderSuggestions(matches, list, input, target) {
            list.innerHTML = '';
            if (matches.length === 0) {
                list.classList.remove('show');
                return;
            }

            matches.forEach(match => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = match;
                div.onclick = () => {
                    addTagToTextarea(match, target);
                    input.value = ''; 
                    list.classList.remove('show'); 
                };
                list.appendChild(div);
            });
            list.classList.add('show');
        }

        function addTagToTextarea(tag, textarea) {
            const current = textarea.value.trim();
            if (current) {
                if (current.endsWith(',')) {
                    textarea.value = current + ' ' + tag;
                } else {
                    textarea.value = current + ', ' + tag;
                }
            } else {
                textarea.value = tag;
            }
        }

        // --- UI Interactions ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Buttons logic
            const btns = {
                'import': document.getElementById('btn-import'),
                'bulk': document.getElementById('btn-bulk'),
                'input': document.getElementById('btn-input'),
                'preview': document.getElementById('btn-preview')
            };

            const inactiveClass = "flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all text-blue-100 hover:bg-blue-600 flex items-center justify-center gap-1 whitespace-nowrap";
            const activeClass = "flex-1 md:flex-none px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-white text-blue-700 shadow flex items-center justify-center gap-1 whitespace-nowrap";

            Object.keys(btns).forEach(key => {
                btns[key].className = (key === tabName) ? activeClass : inactiveClass;
            });

            if (tabName === 'preview') {
                generateCSV();
            }
        }

        function toggleSection(contentId, header) {
            const content = document.getElementById(contentId);
            const isHidden = content.classList.contains('hidden');
            if (isHidden) {
                content.classList.remove('hidden');
                header.setAttribute('aria-expanded', 'true');
            } else {
                content.classList.add('hidden');
                header.setAttribute('aria-expanded', 'false');
            }
        }

        // --- Form Management ---
        function addForm(sourceData = null) {
            const template = document.getElementById('form-template');
            const clone = template.content.cloneNode(true);
            const formContainer = document.getElementById('forms-container');
            
            const uniqueId = Date.now();
            const formEl = clone.querySelector('.form-item');
            formEl.dataset.id = uniqueId;
            
            // Elements
            const inputs = {
                mode: formEl.querySelector('.form-mode'),
                label: formEl.querySelector('.form-label-input'),
                name: formEl.querySelector('.form-name'),
                idVal: formEl.querySelector('.form-id-val'),
                links: formEl.querySelector('.form-links'),
                stats: formEl.querySelector('.form-stats'),
                attacks: formEl.querySelector('.form-attacks'),
                passive: formEl.querySelector('.form-passive'),
                active: formEl.querySelector('.form-active'),
                standby: formEl.querySelector('.form-standby'),
                field: formEl.querySelector('.form-field'),
                reversible: formEl.querySelector('.form-reversible')
            };

            // Set Values
            if (sourceData) {
                inputs.mode.value = sourceData.mode;
                inputs.label.value = sourceData.label + ' (コピー)';
                inputs.name.value = sourceData.name;
                inputs.idVal.value = sourceData.idVal;
                inputs.links.value = sourceData.links;
                inputs.stats.value = sourceData.stats;
                inputs.attacks.value = sourceData.attacks;
                inputs.passive.value = sourceData.passive;
                inputs.active.value = sourceData.active;
                inputs.standby.value = sourceData.standby;
                inputs.field.value = sourceData.field;
                inputs.reversible.value = sourceData.reversible;
            } else {
                inputs.stats.value = DEFAULTS.stats;
                inputs.attacks.value = DEFAULTS.attacks;
                inputs.passive.value = DEFAULTS.passive;
                inputs.active.value = DEFAULTS.active;
                inputs.standby.value = DEFAULTS.standby;
                inputs.field.value = DEFAULTS.field;
            }

            // Setup Search for Links
            const linkSearchId = `link-search-${uniqueId}`;
            const linkListId = `link-list-${uniqueId}`;
            const linkTargetId = `link-target-${uniqueId}`;

            formEl.querySelector('.link-search').id = linkSearchId;
            formEl.querySelector('.link-suggestions').id = linkListId;
            inputs.links.id = linkTargetId;

            // Setup Actions
            formEl.querySelector('.btn-remove').onclick = () => removeForm(uniqueId);
            formEl.querySelector('.btn-duplicate').onclick = () => duplicateForm(formEl);

            formContainer.appendChild(clone);
            updateFormIndices();
            lucide.createIcons();

            // Init Search
            setupTagSearch(linkSearchId, linkListId, linkTargetId, availableLinks);
        }

        function removeForm(id) {
            const formContainer = document.getElementById('forms-container');
            const items = formContainer.querySelectorAll('.form-item');
            if (items.length <= 1) return;
            const itemToRemove = formContainer.querySelector(`.form-item[data-id="${id}"]`);
            if (itemToRemove) {
                itemToRemove.remove();
                updateFormIndices();
            }
        }

        function duplicateForm(sourceEl) {
            const data = {
                mode: sourceEl.querySelector('.form-mode').value,
                label: sourceEl.querySelector('.form-label-input').value,
                name: sourceEl.querySelector('.form-name').value,
                idVal: sourceEl.querySelector('.form-id-val').value,
                links: sourceEl.querySelector('.form-links').value,
                stats: sourceEl.querySelector('.form-stats').value,
                attacks: sourceEl.querySelector('.form-attacks').value,
                passive: sourceEl.querySelector('.form-passive').value,
                active: sourceEl.querySelector('.form-active').value,
                standby: sourceEl.querySelector('.form-standby').value,
                field: sourceEl.querySelector('.form-field').value,
                reversible: sourceEl.querySelector('.form-reversible').value
            };
            addForm(data);
        }

        function updateFormIndices() {
            const items = document.querySelectorAll('.form-item');
            items.forEach((item, index) => {
                item.querySelector('.form-index').textContent = `#${index + 1}`;
            });
        }

        // --- CSV/TSV Gen Logic ---
        function getSafeValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }
        
        // Escape for CSV (Excel/Google Sheets style)
        function escapeCsv(str) {
            if (!str) return '';
            return `"${str.replace(/"/g, '""')}"`;
        }

        // Escape for TSV (Remove newlines to keep it in one cell if needed, or wrap quotes)
        // Sheets paste works best with tab delimiters and quotes for multi-line
        function formatField(str, mode) {
            if (mode === 'csv') {
                return escapeCsv(str);
            } else {
                // For TSV paste to sheets, wrapping in quotes usually handles newlines correctly
                if (!str) return '';
                // If contains tab or newline, wrap in quotes
                if (str.includes('\t') || str.includes('\n') || str.includes('"')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            }
        }

        function generateCSV() {
            const delimiter = outputMode === 'csv' ? ',' : '\t';
            const charId = getSafeValue('char-id');

            const charData = [
                charId,
                getSafeValue('char-title'),
                getSafeValue('char-name'),
                getSafeValue('char-yomi'),
                getSafeValue('char-rarity'),
                getSafeValue('char-cost'),
                getSafeValue('char-type'),
                getSafeValue('char-class'),
                getSafeValue('char-release'),
                getSafeValue('char-eza'),
                getSafeValue('char-seza'),
                getSafeValue('ls-normal'),
                getSafeValue('ls-eza'),
                getSafeValue('ls-seza'),
                formatField(getSafeValue('char-categories'), outputMode),
                formatField(getSafeValue('char-awakening'), outputMode),
                getSafeValue('char-source'),
                getSafeValue('char-dropevent')
            ].join(delimiter);
            
            document.getElementById('output-char').textContent = charData;

            const formItems = document.querySelectorAll('.form-item');
            const formRows = Array.from(formItems).map(item => {
                return [
                    charId,
                    item.querySelector('.form-mode').value,
                    item.querySelector('.form-label-input').value,
                    item.querySelector('.form-name').value,
                    item.querySelector('.form-id-val').value,
                    formatField(item.querySelector('.form-links').value, outputMode),
                    formatField(item.querySelector('.form-stats').value, outputMode),
                    formatField(item.querySelector('.form-attacks').value, outputMode),
                    formatField(item.querySelector('.form-passive').value, outputMode),
                    formatField(item.querySelector('.form-active').value, outputMode),
                    formatField(item.querySelector('.form-standby').value, outputMode),
                    formatField(item.querySelector('.form-field').value, outputMode),
                    item.querySelector('.form-reversible').value
                ].join(delimiter);
            }).join('\n');
            document.getElementById('output-forms').textContent = formRows;
        }

        function copyToClipboard(elementId, btn) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> 完了`;
                btn.classList.remove('bg-slate-700', 'hover:bg-slate-600');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.add('bg-slate-700', 'hover:bg-slate-600');
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    lucide.createIcons();
                }, 2000);
            }).catch(err => alert("コピーに失敗しました。"));
        }
    </script>
</body>
</html>